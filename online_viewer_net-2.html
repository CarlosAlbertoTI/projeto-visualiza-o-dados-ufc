<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>BRUMS: Visualização Final (Radar Ampliado)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        :root {
            --color-pre: #adb5bd;       /* Cinza (Neutro) */
            --color-post: #212529;      /* Preto (Forte) */
            --color-highlight: #ffc107; /* Amarelo (Destaque) */
            --color-judo: #0d6efd;      /* Azul Judo */
            --color-jiu: #d63384;       /* Rosa/Roxo Jiu */
            --color-muay: #dc3545;      /* Vermelho Muay Thai */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            color: #212529;
            overflow-x: hidden;
        }

        /* --- HERO SECTION --- */
        .hero-section {
            height: 90vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #212529 0%, #343a40 100%);
            color: white;
            text-align: center;
            margin-bottom: 50px;
        }

        .hero-title { font-size: 3.5rem; font-weight: 800; margin-bottom: 20px; opacity: 0; animation: fadeUp 1s ease-out forwards; }
        .hero-subtitle { font-size: 1.2rem; font-weight: 300; opacity: 0.8; max-width: 600px; opacity: 0; animation: fadeUp 1s ease-out 0.5s forwards; }
        .scroll-indicator { margin-top: 50px; opacity: 0; animation: bounce 2s infinite 1.5s; }

        /* --- STORY SECTIONS --- */
        .story-section {
            min-height: 80vh; 
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 50px 0;
            opacity: 0; 
            transition: opacity 1s ease-out, transform 1s ease-out;
            transform: translateY(50px);
        }

        .story-section.visible { opacity: 1; transform: translateY(0); }

        .chart-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            padding: 40px;
            width: 100%;
            max-width: 900px;
            position: relative;
            overflow: hidden;
        }

        /* Badge de Escala */
        .scale-badge {
            font-size: 0.75rem;
            background: #e9ecef;
            color: #495057;
            padding: 4px 8px;
            border-radius: 4px;
            margin-left: 10px;
            font-weight: 600;
        }

        @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0); opacity: 1;} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }

        .d3-tooltip {
            position: absolute; padding: 10px 15px; background: rgba(0,0,0,0.9); color: #fff;
            border-radius: 8px; pointer-events: none; opacity: 0; font-size: 0.8rem; z-index: 100;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: all 0.1s;
        }
        
        .axis text { font-family: 'Inter', sans-serif; font-size: 12px; fill: #6c757d; }
        .axis path, .axis line { stroke: #e9ecef; }
        
        .grid line {
            stroke: #f8f9fa;
            stroke-opacity: 0.7;
            shape-rendering: crispEdges;
        }
    </style>
</head>
<body>

<div class="hero-section">
    <div class="hero-title">O Efeito do Treino</div>
    <div class="hero-subtitle">
        Visualização com <strong>Design Otimizado</strong>.<br>
        Permite comparar a magnitude real entre diferentes sentimentos.
    </div>
    <div class="scroll-indicator">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <path d="M7 13l5 5 5-5M7 6l5 5 5-5"/>
        </svg>
    </div>
</div>

<div class="container">
    
    <div class="story-section" id="section-tmd">
        <div class="chart-card">
            <h2 class="fw-bold mb-4">1. O Impacto Global (TMD)</h2>
            <div class="row">
                <div class="col-md-4">
                    <p class="lead">Distúrbio Total de Humor.</p>
                    <p class="text-muted">Escala ajustada para focar na distribuição da densidade.</p>
                    <div class="small text-muted mt-3">
                        O TMD é calculado somando os sentimentos negativos e subtraindo o Vigor. Valores menores indicam melhor saúde mental.
                    </div>
                </div>
                <div class="col-md-8">
                    <div id="chart-tmd" style="height: 350px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="story-section" id="section-radar">
        <div class="chart-card">
            <div class="d-flex align-items-center mb-4">
                <h2 class="fw-bold m-0">2. O Perfil Iceberg</h2>
                <span class="scale-badge">Escala Fixa: 0-18</span>
            </div>
            
            <div class="row align-items-center">
                <div class="col-md-7 order-md-2">
                    <div id="chart-radar" style="height: 700px;"></div>
                </div>
                <div class="col-md-5 order-md-1">
                    <p class="lead">Visualização da "Forma".</p>
                    <p class="text-muted">A escala fixa impede que valores baixos pareçam enormes no gráfico.</p>
                    <p class="text-muted">Note como o <strong>Vigor</strong> domina o gráfico, criando a ponta do iceberg.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="story-section" id="section-dumbbell">
        <div class="chart-card">
            <div class="d-flex align-items-center mb-4">
                <h2 class="fw-bold m-0">3. Os Componentes da Mudança</h2>
                <span class="scale-badge">Zoom Automático + Indicador de Status</span>
            </div>
            <p class="text-muted text-center mb-5">
                O círculo <strong>branco</strong> representa o início (Pré). O círculo <strong>colorido</strong> é o final (Pós).
            </p>
            <div id="chart-dumbbell" style="height: 500px;"></div>
            <div class="text-center mt-3 small text-muted">
                <span style="color: #198754; font-weight: bold;">Verde</span>: Melhora &bull; 
                <span style="color: #dc3545; font-weight: bold;">Vermelho</span>: Piora
            </div>
        </div>
    </div>

    <div class="story-section" id="section-slope">
        <div class="chart-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="d-flex align-items-center">
                    <h2 class="fw-bold m-0">4. Detalhe Individual</h2>
                    <span class="scale-badge">Eixo Y Padronizado</span>
                </div>
                <select id="scaleSelect" class="form-select w-auto shadow-sm"></select>
            </div>
            <p class="text-muted mb-4">Compare as linhas individuais com a mesma referência visual.</p>
            <div id="chart-slope" style="height: 400px;"></div>
            <div class="d-flex justify-content-center gap-4 mt-3 small fw-bold" id="legend-modalities">
            </div>
        </div>
    </div>

    <div style="height: 20vh;"></div>
</div>

<script>
    // =========================================================================
    // DADOS REAIS
    // =========================================================================
    const rawData = [{"id": "1", "modality": "Judô", "scale": "Tensão", "pre": 1.0, "post": 0.0}, {"id": "1", "modality": "Judô", "scale": "Depressão", "pre": 2.0, "post": 0.0}, {"id": "1", "modality": "Judô", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "1", "modality": "Judô", "scale": "Fadiga", "pre": 3.0, "post": 0.0}, {"id": "1", "modality": "Judô", "scale": "Confusão", "pre": 0.0, "post": 0.0}, {"id": "1", "modality": "Judô", "scale": "Vigor", "pre": 7.0, "post": 10.0}, {"id": "2", "modality": "Jiu-Jitsu", "scale": "Tensão", "pre": 4.0, "post": 3.0}, {"id": "2", "modality": "Jiu-Jitsu", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "2", "modality": "Jiu-Jitsu", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "2", "modality": "Jiu-Jitsu", "scale": "Fadiga", "pre": 1.0, "post": 4.0}, {"id": "2", "modality": "Jiu-Jitsu", "scale": "Confusão", "pre": 1.0, "post": 2.0}, {"id": "2", "modality": "Jiu-Jitsu", "scale": "Vigor", "pre": 10.0, "post": 8.0}, {"id": "3", "modality": "Jiu-Jitsu", "scale": "Tensão", "pre": 1.0, "post": 1.0}, {"id": "3", "modality": "Jiu-Jitsu", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "3", "modality": "Jiu-Jitsu", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "3", "modality": "Jiu-Jitsu", "scale": "Fadiga", "pre": 3.0, "post": 3.0}, {"id": "3", "modality": "Jiu-Jitsu", "scale": "Confusão", "pre": 0.0, "post": 2.0}, {"id": "3", "modality": "Jiu-Jitsu", "scale": "Vigor", "pre": 7.0, "post": 7.0}, {"id": "4", "modality": "Jiu-Jitsu", "scale": "Tensão", "pre": 0.0, "post": 0.0}, {"id": "4", "modality": "Jiu-Jitsu", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "4", "modality": "Jiu-Jitsu", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "4", "modality": "Jiu-Jitsu", "scale": "Fadiga", "pre": 4.0, "post": 0.0}, {"id": "4", "modality": "Jiu-Jitsu", "scale": "Confusão", "pre": 1.0, "post": 0.0}, {"id": "4", "modality": "Jiu-Jitsu", "scale": "Vigor", "pre": 4.0, "post": 6.0}, {"id": "5", "modality": "Jiu-Jitsu", "scale": "Tensão", "pre": 1.0, "post": 0.0}, {"id": "5", "modality": "Jiu-Jitsu", "scale": "Depressão", "pre": 1.0, "post": 0.0}, {"id": "5", "modality": "Jiu-Jitsu", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "5", "modality": "Jiu-Jitsu", "scale": "Fadiga", "pre": 10.0, "post": 8.0}, {"id": "5", "modality": "Jiu-Jitsu", "scale": "Confusão", "pre": 0.0, "post": 0.0}, {"id": "5", "modality": "Jiu-Jitsu", "scale": "Vigor", "pre": 5.0, "post": 13.0}, {"id": "6", "modality": "Judô", "scale": "Tensão", "pre": 3.0, "post": 3.0}, {"id": "6", "modality": "Judô", "scale": "Depressão", "pre": 1.0, "post": 0.0}, {"id": "6", "modality": "Judô", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "6", "modality": "Judô", "scale": "Fadiga", "pre": 3.0, "post": 1.0}, {"id": "6", "modality": "Judô", "scale": "Confusão", "pre": 1.0, "post": 0.0}, {"id": "6", "modality": "Judô", "scale": "Vigor", "pre": 10.0, "post": 10.0}, {"id": "7", "modality": "Judô", "scale": "Tensão", "pre": 4.0, "post": 4.0}, {"id": "7", "modality": "Judô", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "7", "modality": "Judô", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "7", "modality": "Judô", "scale": "Fadiga", "pre": 8.0, "post": 7.0}, {"id": "7", "modality": "Judô", "scale": "Confusão", "pre": 3.0, "post": 1.0}, {"id": "7", "modality": "Judô", "scale": "Vigor", "pre": 4.0, "post": 6.0}, {"id": "8", "modality": "Judô", "scale": "Tensão", "pre": 0.0, "post": 0.0}, {"id": "8", "modality": "Judô", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "8", "modality": "Judô", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "8", "modality": "Judô", "scale": "Fadiga", "pre": 0.0, "post": 0.0}, {"id": "8", "modality": "Judô", "scale": "Confusão", "pre": 0.0, "post": 0.0}, {"id": "8", "modality": "Judô", "scale": "Vigor", "pre": 8.0, "post": 13.0}, {"id": "9", "modality": "Judô", "scale": "Tensão", "pre": 4.0, "post": 3.0}, {"id": "9", "modality": "Judô", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "9", "modality": "Judô", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "9", "modality": "Judô", "scale": "Fadiga", "pre": 4.0, "post": 6.0}, {"id": "9", "modality": "Judô", "scale": "Confusão", "pre": 0.0, "post": 0.0}, {"id": "9", "modality": "Judô", "scale": "Vigor", "pre": 9.0, "post": 6.0}, {"id": "10", "modality": "Judô", "scale": "Tensão", "pre": 6.0, "post": 2.0}, {"id": "10", "modality": "Judô", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "10", "modality": "Judô", "scale": "Raiva", "pre": 3.0, "post": 0.0}, {"id": "10", "modality": "Judô", "scale": "Fadiga", "pre": 2.0, "post": 2.0}, {"id": "10", "modality": "Judô", "scale": "Confusão", "pre": 3.0, "post": 0.0}, {"id": "10", "modality": "Judô", "scale": "Vigor", "pre": 12.0, "post": 12.0}, {"id": "11", "modality": "Judô", "scale": "Tensão", "pre": 1.0, "post": 0.0}, {"id": "11", "modality": "Judô", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "11", "modality": "Judô", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "11", "modality": "Judô", "scale": "Fadiga", "pre": 1.0, "post": 3.0}, {"id": "11", "modality": "Judô", "scale": "Confusão", "pre": 0.0, "post": 0.0}, {"id": "11", "modality": "Judô", "scale": "Vigor", "pre": 13.0, "post": 10.0}, {"id": "12", "modality": "Judô", "scale": "Tensão", "pre": 3.0, "post": 0.0}, {"id": "12", "modality": "Judô", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "12", "modality": "Judô", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "12", "modality": "Judô", "scale": "Fadiga", "pre": 5.0, "post": 5.0}, {"id": "12", "modality": "Judô", "scale": "Confusão", "pre": 0.0, "post": 0.0}, {"id": "12", "modality": "Judô", "scale": "Vigor", "pre": 10.0, "post": 11.0}, {"id": "13", "modality": "Judô", "scale": "Tensão", "pre": 2.0, "post": 0.0}, {"id": "13", "modality": "Judô", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "13", "modality": "Judô", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "13", "modality": "Judô", "scale": "Fadiga", "pre": 2.0, "post": 3.0}, {"id": "13", "modality": "Judô", "scale": "Confusão", "pre": 0.0, "post": 0.0}, {"id": "13", "modality": "Judô", "scale": "Vigor", "pre": 13.0, "post": 10.0}, {"id": "14", "modality": "Judô", "scale": "Tensão", "pre": 0.0, "post": 0.0}, {"id": "14", "modality": "Judô", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "14", "modality": "Judô", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "14", "modality": "Judô", "scale": "Fadiga", "pre": 3.0, "post": 5.0}, {"id": "14", "modality": "Judô", "scale": "Confusão", "pre": 0.0, "post": 0.0}, {"id": "14", "modality": "Judô", "scale": "Vigor", "pre": 14.0, "post": 12.0}, {"id": "15", "modality": "Judô", "scale": "Tensão", "pre": 0.0, "post": 0.0}, {"id": "15", "modality": "Judô", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "15", "modality": "Judô", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "15", "modality": "Judô", "scale": "Fadiga", "pre": 1.0, "post": 0.0}, {"id": "15", "modality": "Judô", "scale": "Confusão", "pre": 0.0, "post": 0.0}, {"id": "15", "modality": "Judô", "scale": "Vigor", "pre": 16.0, "post": 16.0}, {"id": "16", "modality": "Judô", "scale": "Tensão", "pre": 5.0, "post": 3.0}, {"id": "16", "modality": "Judô", "scale": "Depressão", "pre": 1.0, "post": 0.0}, {"id": "16", "modality": "Judô", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "16", "modality": "Judô", "scale": "Fadiga", "pre": 5.0, "post": 3.0}, {"id": "16", "modality": "Judô", "scale": "Confusão", "pre": 1.0, "post": 0.0}, {"id": "16", "modality": "Judô", "scale": "Vigor", "pre": 12.0, "post": 12.0}, {"id": "17", "modality": "Judô", "scale": "Tensão", "pre": 5.0, "post": 1.0}, {"id": "17", "modality": "Judô", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "17", "modality": "Judô", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "17", "modality": "Judô", "scale": "Fadiga", "pre": 4.0, "post": 8.0}, {"id": "17", "modality": "Judô", "scale": "Confusão", "pre": 3.0, "post": 1.0}, {"id": "17", "modality": "Judô", "scale": "Vigor", "pre": 10.0, "post": 12.0}, {"id": "18", "modality": "Judô", "scale": "Tensão", "pre": 1.0, "post": 0.0}, {"id": "18", "modality": "Judô", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "18", "modality": "Judô", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "18", "modality": "Judô", "scale": "Fadiga", "pre": 1.0, "post": 1.0}, {"id": "18", "modality": "Judô", "scale": "Confusão", "pre": 1.0, "post": 0.0}, {"id": "18", "modality": "Judô", "scale": "Vigor", "pre": 9.0, "post": 8.0}, {"id": "19", "modality": "Judô", "scale": "Tensão", "pre": 5.0, "post": 2.0}, {"id": "19", "modality": "Judô", "scale": "Depressão", "pre": 2.0, "post": 0.0}, {"id": "19", "modality": "Judô", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "19", "modality": "Judô", "scale": "Fadiga", "pre": 3.0, "post": 1.0}, {"id": "19", "modality": "Judô", "scale": "Confusão", "pre": 2.0, "post": 0.0}, {"id": "19", "modality": "Judô", "scale": "Vigor", "pre": 6.0, "post": 7.0}, {"id": "20", "modality": "Jiu-Jitsu", "scale": "Tensão", "pre": 3.0, "post": 1.0}, {"id": "20", "modality": "Jiu-Jitsu", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "20", "modality": "Jiu-Jitsu", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "20", "modality": "Jiu-Jitsu", "scale": "Fadiga", "pre": 5.0, "post": 2.0}, {"id": "20", "modality": "Jiu-Jitsu", "scale": "Confusão", "pre": 3.0, "post": 0.0}, {"id": "20", "modality": "Jiu-Jitsu", "scale": "Vigor", "pre": 8.0, "post": 10.0}, {"id": "21", "modality": "Jiu-Jitsu", "scale": "Tensão", "pre": 0.0, "post": 0.0}, {"id": "21", "modality": "Jiu-Jitsu", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "21", "modality": "Jiu-Jitsu", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "21", "modality": "Jiu-Jitsu", "scale": "Fadiga", "pre": 0.0, "post": 0.0}, {"id": "21", "modality": "Jiu-Jitsu", "scale": "Confusão", "pre": 0.0, "post": 0.0}, {"id": "21", "modality": "Jiu-Jitsu", "scale": "Vigor", "pre": 14.0, "post": 16.0}, {"id": "22", "modality": "Jiu-Jitsu", "scale": "Tensão", "pre": 3.0, "post": 3.0}, {"id": "22", "modality": "Jiu-Jitsu", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "22", "modality": "Jiu-Jitsu", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "22", "modality": "Jiu-Jitsu", "scale": "Fadiga", "pre": 5.0, "post": 4.0}, {"id": "22", "modality": "Jiu-Jitsu", "scale": "Confusão", "pre": 3.0, "post": 0.0}, {"id": "22", "modality": "Jiu-Jitsu", "scale": "Vigor", "pre": 6.0, "post": 11.0}, {"id": "23", "modality": "Jiu-Jitsu", "scale": "Tensão", "pre": 2.0, "post": 0.0}, {"id": "23", "modality": "Jiu-Jitsu", "scale": "Depressão", "pre": 1.0, "post": 0.0}, {"id": "23", "modality": "Jiu-Jitsu", "scale": "Raiva", "pre": 2.0, "post": 0.0}, {"id": "23", "modality": "Jiu-Jitsu", "scale": "Fadiga", "pre": 3.0, "post": 3.0}, {"id": "23", "modality": "Jiu-Jitsu", "scale": "Confusão", "pre": 0.0, "post": 0.0}, {"id": "23", "modality": "Jiu-Jitsu", "scale": "Vigor", "pre": 6.0, "post": 11.0}, {"id": "24", "modality": "Jiu-Jitsu", "scale": "Tensão", "pre": 5.0, "post": 4.0}, {"id": "24", "modality": "Jiu-Jitsu", "scale": "Depressão", "pre": 5.0, "post": 2.0}, {"id": "24", "modality": "Jiu-Jitsu", "scale": "Raiva", "pre": 2.0, "post": 2.0}, {"id": "24", "modality": "Jiu-Jitsu", "scale": "Fadiga", "pre": 9.0, "post": 5.0}, {"id": "24", "modality": "Jiu-Jitsu", "scale": "Confusão", "pre": 3.0, "post": 2.0}, {"id": "24", "modality": "Jiu-Jitsu", "scale": "Vigor", "pre": 5.0, "post": 5.0}, {"id": "25", "modality": "Jiu-Jitsu", "scale": "Tensão", "pre": 3.0, "post": 1.0}, {"id": "25", "modality": "Jiu-Jitsu", "scale": "Depressão", "pre": 1.0, "post": 0.0}, {"id": "25", "modality": "Jiu-Jitsu", "scale": "Raiva", "pre": 2.0, "post": 0.0}, {"id": "25", "modality": "Jiu-Jitsu", "scale": "Fadiga", "pre": 2.0, "post": 1.0}, {"id": "25", "modality": "Jiu-Jitsu", "scale": "Confusão", "pre": 1.0, "post": 1.0}, {"id": "25", "modality": "Jiu-Jitsu", "scale": "Vigor", "pre": 15.0, "post": 12.0}, {"id": "26", "modality": "Jiu-Jitsu", "scale": "Tensão", "pre": 6.0, "post": 4.0}, {"id": "26", "modality": "Jiu-Jitsu", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "26", "modality": "Jiu-Jitsu", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "26", "modality": "Jiu-Jitsu", "scale": "Fadiga", "pre": 11.0, "post": 8.0}, {"id": "26", "modality": "Jiu-Jitsu", "scale": "Confusão", "pre": 1.0, "post": 0.0}, {"id": "26", "modality": "Jiu-Jitsu", "scale": "Vigor", "pre": 8.0, "post": 9.0}, {"id": "27", "modality": "Judô", "scale": "Tensão", "pre": 0.0, "post": 0.0}, {"id": "27", "modality": "Judô", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "27", "modality": "Judô", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "27", "modality": "Judô", "scale": "Fadiga", "pre": 0.0, "post": 0.0}, {"id": "27", "modality": "Judô", "scale": "Confusão", "pre": 0.0, "post": 0.0}, {"id": "27", "modality": "Judô", "scale": "Vigor", "pre": 8.0, "post": 12.0}, {"id": "28", "modality": "Judô", "scale": "Tensão", "pre": 7.0, "post": 0.0}, {"id": "28", "modality": "Judô", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "28", "modality": "Judô", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "28", "modality": "Judô", "scale": "Fadiga", "pre": 8.0, "post": 8.0}, {"id": "28", "modality": "Judô", "scale": "Confusão", "pre": 0.0, "post": 0.0}, {"id": "28", "modality": "Judô", "scale": "Vigor", "pre": 4.0, "post": 4.0}, {"id": "29", "modality": "Judô", "scale": "Tensão", "pre": 4.0, "post": 1.0}, {"id": "29", "modality": "Judô", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "29", "modality": "Judô", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "29", "modality": "Judô", "scale": "Fadiga", "pre": 3.0, "post": 5.0}, {"id": "29", "modality": "Judô", "scale": "Confusão", "pre": 0.0, "post": 0.0}, {"id": "29", "modality": "Judô", "scale": "Vigor", "pre": 12.0, "post": 11.0}, {"id": "30", "modality": "Judô", "scale": "Tensão", "pre": 0.0, "post": 0.0}, {"id": "30", "modality": "Judô", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "30", "modality": "Judô", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "30", "modality": "Judô", "scale": "Fadiga", "pre": 4.0, "post": 5.0}, {"id": "30", "modality": "Judô", "scale": "Confusão", "pre": 0.0, "post": 0.0}, {"id": "30", "modality": "Judô", "scale": "Vigor", "pre": 13.0, "post": 13.0}, {"id": "31", "modality": "Judô", "scale": "Tensão", "pre": 3.0, "post": 0.0}, {"id": "31", "modality": "Judô", "scale": "Depressão", "pre": 2.0, "post": 0.0}, {"id": "31", "modality": "Judô", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "31", "modality": "Judô", "scale": "Fadiga", "pre": 0.0, "post": 0.0}, {"id": "31", "modality": "Judô", "scale": "Confusão", "pre": 0.0, "post": 0.0}, {"id": "31", "modality": "Judô", "scale": "Vigor", "pre": 11.0, "post": 9.0}, {"id": "32", "modality": "Judô", "scale": "Tensão", "pre": 5.0, "post": 3.0}, {"id": "32", "modality": "Judô", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "32", "modality": "Judô", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "32", "modality": "Judô", "scale": "Fadiga", "pre": 4.0, "post": 5.0}, {"id": "32", "modality": "Judô", "scale": "Confusão", "pre": 1.0, "post": 0.0}, {"id": "32", "modality": "Judô", "scale": "Vigor", "pre": 13.0, "post": 10.0}, {"id": "33", "modality": "Jiu-Jitsu", "scale": "Tensão", "pre": 4.0, "post": 2.0}, {"id": "33", "modality": "Jiu-Jitsu", "scale": "Depressão", "pre": 1.0, "post": 0.0}, {"id": "33", "modality": "Jiu-Jitsu", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "33", "modality": "Jiu-Jitsu", "scale": "Fadiga", "pre": 5.0, "post": 3.0}, {"id": "33", "modality": "Jiu-Jitsu", "scale": "Confusão", "pre": 3.0, "post": 1.0}, {"id": "33", "modality": "Jiu-Jitsu", "scale": "Vigor", "pre": 12.0, "post": 13.0}, {"id": "34", "modality": "Jiu-Jitsu", "scale": "Tensão", "pre": 2.0, "post": 3.0}, {"id": "34", "modality": "Jiu-Jitsu", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "34", "modality": "Jiu-Jitsu", "scale": "Raiva", "pre": 1.0, "post": 0.0}, {"id": "34", "modality": "Jiu-Jitsu", "scale": "Fadiga", "pre": 4.0, "post": 6.0}, {"id": "34", "modality": "Jiu-Jitsu", "scale": "Confusão", "pre": 1.0, "post": 2.0}, {"id": "34", "modality": "Jiu-Jitsu", "scale": "Vigor", "pre": 12.0, "post": 12.0}, {"id": "35", "modality": "Jiu-Jitsu", "scale": "Tensão", "pre": 5.0, "post": 2.0}, {"id": "35", "modality": "Jiu-Jitsu", "scale": "Depressão", "pre": 1.0, "post": 0.0}, {"id": "35", "modality": "Jiu-Jitsu", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "35", "modality": "Jiu-Jitsu", "scale": "Fadiga", "pre": 7.0, "post": 5.0}, {"id": "35", "modality": "Jiu-Jitsu", "scale": "Confusão", "pre": 2.0, "post": 1.0}, {"id": "35", "modality": "Jiu-Jitsu", "scale": "Vigor", "pre": 6.0, "post": 7.0}, {"id": "36", "modality": "Jiu-Jitsu", "scale": "Tensão", "pre": 2.0, "post": 2.0}, {"id": "36", "modality": "Jiu-Jitsu", "scale": "Depressão", "pre": 2.0, "post": 2.0}, {"id": "36", "modality": "Jiu-Jitsu", "scale": "Raiva", "pre": 1.0, "post": 2.0}, {"id": "36", "modality": "Jiu-Jitsu", "scale": "Fadiga", "pre": 6.0, "post": 7.0}, {"id": "36", "modality": "Jiu-Jitsu", "scale": "Confusão", "pre": 0.0, "post": 0.0}, {"id": "36", "modality": "Jiu-Jitsu", "scale": "Vigor", "pre": 10.0, "post": 11.0}, {"id": "37", "modality": "Jiu-Jitsu", "scale": "Tensão", "pre": 5.0, "post": 2.0}, {"id": "37", "modality": "Jiu-Jitsu", "scale": "Depressão", "pre": 2.0, "post": 1.0}, {"id": "37", "modality": "Jiu-Jitsu", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "37", "modality": "Jiu-Jitsu", "scale": "Fadiga", "pre": 12.0, "post": 10.0}, {"id": "37", "modality": "Jiu-Jitsu", "scale": "Confusão", "pre": 3.0, "post": 2.0}, {"id": "37", "modality": "Jiu-Jitsu", "scale": "Vigor", "pre": 2.0, "post": 3.0}, {"id": "38", "modality": "Jiu-Jitsu", "scale": "Tensão", "pre": 2.0, "post": 1.0}, {"id": "38", "modality": "Jiu-Jitsu", "scale": "Depressão", "pre": 1.0, "post": 0.0}, {"id": "38", "modality": "Jiu-Jitsu", "scale": "Raiva", "pre": 2.0, "post": 0.0}, {"id": "38", "modality": "Jiu-Jitsu", "scale": "Fadiga", "pre": 6.0, "post": 3.0}, {"id": "38", "modality": "Jiu-Jitsu", "scale": "Confusão", "pre": 3.0, "post": 2.0}, {"id": "38", "modality": "Jiu-Jitsu", "scale": "Vigor", "pre": 7.0, "post": 5.0}, {"id": "39", "modality": "Jiu-Jitsu", "scale": "Tensão", "pre": 5.0, "post": 3.0}, {"id": "39", "modality": "Jiu-Jitsu", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "39", "modality": "Jiu-Jitsu", "scale": "Raiva", "pre": 1.0, "post": 0.0}, {"id": "39", "modality": "Jiu-Jitsu", "scale": "Fadiga", "pre": 8.0, "post": 6.0}, {"id": "39", "modality": "Jiu-Jitsu", "scale": "Confusão", "pre": 1.0, "post": 1.0}, {"id": "39", "modality": "Jiu-Jitsu", "scale": "Vigor", "pre": 9.0, "post": 10.0}, {"id": "40", "modality": "Judô", "scale": "Tensão", "pre": 1.0, "post": 0.0}, {"id": "40", "modality": "Judô", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "40", "modality": "Judô", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "40", "modality": "Judô", "scale": "Fadiga", "pre": 0.0, "post": 0.0}, {"id": "40", "modality": "Judô", "scale": "Confusão", "pre": 0.0, "post": 0.0}, {"id": "40", "modality": "Judô", "scale": "Vigor", "pre": 7.0, "post": 11.0}, {"id": "41", "modality": "Judô", "scale": "Tensão", "pre": 1.0, "post": 0.0}, {"id": "41", "modality": "Judô", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "41", "modality": "Judô", "scale": "Raiva", "pre": 1.0, "post": 0.0}, {"id": "41", "modality": "Judô", "scale": "Fadiga", "pre": 0.0, "post": 0.0}, {"id": "41", "modality": "Judô", "scale": "Confusão", "pre": 0.0, "post": 0.0}, {"id": "41", "modality": "Judô", "scale": "Vigor", "pre": 13.0, "post": 12.0}, {"id": "42", "modality": "Judô", "scale": "Tensão", "pre": 3.0, "post": 1.0}, {"id": "42", "modality": "Judô", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "42", "modality": "Judô", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "42", "modality": "Judô", "scale": "Fadiga", "pre": 4.0, "post": 4.0}, {"id": "42", "modality": "Judô", "scale": "Confusão", "pre": 1.0, "post": 0.0}, {"id": "42", "modality": "Judô", "scale": "Vigor", "pre": 6.0, "post": 7.0}, {"id": "43", "modality": "Judô", "scale": "Tensão", "pre": 0.0, "post": 0.0}, {"id": "43", "modality": "Judô", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "43", "modality": "Judô", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "43", "modality": "Judô", "scale": "Fadiga", "pre": 0.0, "post": 0.0}, {"id": "43", "modality": "Judô", "scale": "Confusão", "pre": 0.0, "post": 0.0}, {"id": "43", "modality": "Judô", "scale": "Vigor", "pre": 6.0, "post": 6.0}, {"id": "44", "modality": "Judô", "scale": "Tensão", "pre": 2.0, "post": 2.0}, {"id": "44", "modality": "Judô", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "44", "modality": "Judô", "scale": "Raiva", "pre": 2.0, "post": 2.0}, {"id": "44", "modality": "Judô", "scale": "Fadiga", "pre": 3.0, "post": 1.0}, {"id": "44", "modality": "Judô", "scale": "Confusão", "pre": 1.0, "post": 0.0}, {"id": "44", "modality": "Judô", "scale": "Vigor", "pre": 10.0, "post": 12.0}, {"id": "45", "modality": "Judô", "scale": "Tensão", "pre": 7.0, "post": 5.0}, {"id": "45", "modality": "Judô", "scale": "Depressão", "pre": 6.0, "post": 0.0}, {"id": "45", "modality": "Judô", "scale": "Raiva", "pre": 4.0, "post": 0.0}, {"id": "45", "modality": "Judô", "scale": "Fadiga", "pre": 4.0, "post": 4.0}, {"id": "45", "modality": "Judô", "scale": "Confusão", "pre": 0.0, "post": 2.0}, {"id": "45", "modality": "Judô", "scale": "Vigor", "pre": 8.0, "post": 13.0}, {"id": "46", "modality": "Judô", "scale": "Tensão", "pre": 9.0, "post": 10.0}, {"id": "46", "modality": "Judô", "scale": "Depressão", "pre": 3.0, "post": 7.0}, {"id": "46", "modality": "Judô", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "46", "modality": "Judô", "scale": "Fadiga", "pre": 7.0, "post": 12.0}, {"id": "46", "modality": "Judô", "scale": "Confusão", "pre": 5.0, "post": 14.0}, {"id": "46", "modality": "Judô", "scale": "Vigor", "pre": 5.0, "post": 2.0}, {"id": "47", "modality": "Muay Thai", "scale": "Tensão", "pre": 0.0, "post": 0.0}, {"id": "47", "modality": "Muay Thai", "scale": "Depressão", "pre": 2.0, "post": 2.0}, {"id": "47", "modality": "Muay Thai", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "47", "modality": "Muay Thai", "scale": "Fadiga", "pre": 0.0, "post": 1.0}, {"id": "47", "modality": "Muay Thai", "scale": "Confusão", "pre": 0.0, "post": 0.0}, {"id": "47", "modality": "Muay Thai", "scale": "Vigor", "pre": 0.0, "post": 0.0}, {"id": "48", "modality": "Muay Thai", "scale": "Tensão", "pre": 4.0, "post": 5.0}, {"id": "48", "modality": "Muay Thai", "scale": "Depressão", "pre": 3.0, "post": 2.0}, {"id": "48", "modality": "Muay Thai", "scale": "Raiva", "pre": 5.0, "post": 5.0}, {"id": "48", "modality": "Muay Thai", "scale": "Fadiga", "pre": 3.0, "post": 10.0}, {"id": "48", "modality": "Muay Thai", "scale": "Confusão", "pre": 0.0, "post": 0.0}, {"id": "48", "modality": "Muay Thai", "scale": "Vigor", "pre": 8.0, "post": 2.0}, {"id": "49", "modality": "Muay Thai", "scale": "Tensão", "pre": 0.0, "post": 0.0}, {"id": "49", "modality": "Muay Thai", "scale": "Depressão", "pre": 1.0, "post": 0.0}, {"id": "49", "modality": "Muay Thai", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "49", "modality": "Muay Thai", "scale": "Fadiga", "pre": 1.0, "post": 2.0}, {"id": "49", "modality": "Muay Thai", "scale": "Confusão", "pre": 2.0, "post": 0.0}, {"id": "49", "modality": "Muay Thai", "scale": "Vigor", "pre": 9.0, "post": 5.0}, {"id": "50", "modality": "Muay Thai", "scale": "Tensão", "pre": 11.0, "post": 11.0}, {"id": "50", "modality": "Muay Thai", "scale": "Depressão", "pre": 3.0, "post": 5.0}, {"id": "50", "modality": "Muay Thai", "scale": "Raiva", "pre": 1.0, "post": 1.0}, {"id": "50", "modality": "Muay Thai", "scale": "Fadiga", "pre": 7.0, "post": 4.0}, {"id": "50", "modality": "Muay Thai", "scale": "Confusão", "pre": 4.0, "post": 1.0}, {"id": "50", "modality": "Muay Thai", "scale": "Vigor", "pre": 4.0, "post": 5.0}, {"id": "51", "modality": "Muay Thai", "scale": "Tensão", "pre": 0.0, "post": 0.0}, {"id": "51", "modality": "Muay Thai", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "51", "modality": "Muay Thai", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "51", "modality": "Muay Thai", "scale": "Fadiga", "pre": 0.0, "post": 0.0}, {"id": "51", "modality": "Muay Thai", "scale": "Confusão", "pre": 0.0, "post": 0.0}, {"id": "51", "modality": "Muay Thai", "scale": "Vigor", "pre": 0.0, "post": 0.0}, {"id": "52", "modality": "Muay Thai", "scale": "Tensão", "pre": 0.0, "post": 0.0}, {"id": "52", "modality": "Muay Thai", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "52", "modality": "Muay Thai", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "52", "modality": "Muay Thai", "scale": "Fadiga", "pre": 0.0, "post": 0.0}, {"id": "52", "modality": "Muay Thai", "scale": "Confusão", "pre": 0.0, "post": 0.0}, {"id": "52", "modality": "Muay Thai", "scale": "Vigor", "pre": 12.0, "post": 8.0}, {"id": "53", "modality": "Muay Thai", "scale": "Tensão", "pre": 0.0, "post": 0.0}, {"id": "53", "modality": "Muay Thai", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "53", "modality": "Muay Thai", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "53", "modality": "Muay Thai", "scale": "Fadiga", "pre": 0.0, "post": 5.0}, {"id": "53", "modality": "Muay Thai", "scale": "Confusão", "pre": 0.0, "post": 0.0}, {"id": "53", "modality": "Muay Thai", "scale": "Vigor", "pre": 9.0, "post": 7.0}, {"id": "54", "modality": "Muay Thai", "scale": "Tensão", "pre": 6.0, "post": 4.0}, {"id": "54", "modality": "Muay Thai", "scale": "Depressão", "pre": 3.0, "post": 1.0}, {"id": "54", "modality": "Muay Thai", "scale": "Raiva", "pre": 2.0, "post": 2.0}, {"id": "54", "modality": "Muay Thai", "scale": "Fadiga", "pre": 9.0, "post": 6.0}, {"id": "54", "modality": "Muay Thai", "scale": "Confusão", "pre": 2.0, "post": 2.0}, {"id": "54", "modality": "Muay Thai", "scale": "Vigor", "pre": 1.0, "post": 2.0}, {"id": "55", "modality": "Muay Thai", "scale": "Tensão", "pre": 2.0, "post": 1.0}, {"id": "55", "modality": "Muay Thai", "scale": "Depressão", "pre": 0.0, "post": 0.0}, {"id": "55", "modality": "Muay Thai", "scale": "Raiva", "pre": 0.0, "post": 0.0}, {"id": "55", "modality": "Muay Thai", "scale": "Fadiga", "pre": 0.0, "post": 2.0}, {"id": "55", "modality": "Muay Thai", "scale": "Confusão", "pre": 2.0, "post": 0.0}, {"id": "55", "modality": "Muay Thai", "scale": "Vigor", "pre": 10.0, "post": 15.0}];

    const scales = [...new Set(rawData.map(d => d.scale))]; 
    const modalities = [...new Set(rawData.map(d => d.modality))];
    const tooltip = d3.select("body").append("div").attr("class", "d3-tooltip");
    
    // Cores das modalidades
    const modColors = {
        'Judô': 'var(--color-judo)',
        'Jiu-Jitsu': 'var(--color-jiu)',
        'Muay Thai': 'var(--color-muay)'
    };
    const getColor = (mod) => modColors[mod] || '#6c757d';

    // Update legend for slope chart
    const legendContainer = d3.select("#legend-modalities");
    modalities.forEach(mod => {
        legendContainer.append("div")
            .style("color", getColor(mod))
            .html(`${mod} (Média)`);
    });

    // --- 1. TMD CHART (DENSITY) ---
    function initTMD() {
        const container = d3.select("#chart-tmd");
        const width = container.node().getBoundingClientRect().width;
        const height = 350;
        const margin = {top: 20, right: 30, bottom: 30, left: 40};

        const svg = container.append("svg").attr("viewBox", `0 0 ${width} ${height}`).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
        
        // Calcular TMD real
        const tmdData = [];
        const uniqueIds = [...new Set(rawData.map(d => d.id))];
        
        uniqueIds.forEach(id => {
            const user = rawData.filter(d => d.id === id);
            // Verifica se tem todos os dados necessários
            const hasAllScales = scales.every(s => user.some(u => u.scale === s));
            
            if(hasAllScales) {
                const getVal = (arr, t) => {
                    const negs = arr.filter(d => d.scale !== 'Vigor');
                    const vig = arr.find(d => d.scale === 'Vigor');
                    if(negs.length > 0 && vig) {
                        return d3.sum(negs, d => d[t]) - vig[t] + 100;
                    }
                    return null;
                };
                const preVal = getVal(user, 'pre');
                const postVal = getVal(user, 'post');
                if(preVal !== null && postVal !== null) tmdData.push({ pre: preVal, post: postVal });
            }
        });

        // Escala focada na distribuição (Density Plot)
        const x = d3.scaleLinear().domain([80, 160]).range([0, width - margin.left - margin.right]);
        const y = d3.scaleLinear().range([height - margin.top - margin.bottom, 0]);

        // KDE Logic
        function kernelDensityEstimator(kernel, X) {
            return function(V) { return X.map(x => [x, d3.mean(V, v => kernel(x - v))]); };
        }
        function kernelEpanechnikov(k) { return v => Math.abs(v /= k) <= 1 ? 0.75 * (1 - v * v) / k : 0; }
        
        const kde = kernelDensityEstimator(kernelEpanechnikov(7), x.ticks(40));
        const densPre = kde(tmdData.map(d => d.pre));
        const densPost = kde(tmdData.map(d => d.post));

        const maxDens = d3.max([...densPre, ...densPost], d => d[1]) || 0.05;
        y.domain([0, maxDens * 1.2]);

        const area = d3.area().curve(d3.curveBasis).x(d => x(d[0])).y0(height - margin.top - margin.bottom).y1(d => y(d[1]));

        svg.append("g").attr("transform", `translate(0,${height - margin.top - margin.bottom})`).call(d3.axisBottom(x));

        const pathPre = svg.append("path").datum(densPre).attr("fill", "var(--color-pre)").attr("opacity", 0.5).attr("d", area);
        const pathPost = svg.append("path").datum(densPost).attr("fill", "var(--color-highlight)").attr("opacity", 0.7).attr("d", area).attr("opacity", 0);

        return function play() {
            pathPre.attr("opacity", 0).transition().duration(1000).attr("opacity", 0.5);
            pathPost.attr("d", area(densPre)).attr("opacity", 0) 
                   .transition().delay(500).duration(1500).ease(d3.easeCubicOut)
                   .attr("opacity", 0.7).attr("d", area(densPost));
        };
    }

    // --- 2. RADAR CHART (AMPLIADO) ---
    function initRadar() {
        const container = d3.select("#chart-radar");
        const width = container.node().getBoundingClientRect().width;
        
        // AUMENTAR AINDA MAIS A ALTURA
        const height = 700; // Aumentado para 700px
        
        // Ajuste de margem
        const margin = 50; 
        const radius = Math.min(width, height) / 2 - margin; 
        
        const svg = container.append("svg").attr("viewBox", `0 0 ${width} ${height}`).append("g").attr("transform", `translate(${width/2},${height/2})`);

        const orderedScales = scales.filter(s => s !== 'Vigor');
        orderedScales.push('Vigor');
        
        const angleSlice = Math.PI * 2 / orderedScales.length;
        
        const rScale = d3.scaleLinear().range([0, radius]).domain([0, 18]);

        orderedScales.forEach((s, i) => {
            const angle = i * angleSlice - Math.PI/2;
            const x = Math.cos(angle) * (radius + 30); // Mais espaço para o texto
            const y = Math.sin(angle) * (radius + 30);
            svg.append("line").attr("x2", Math.cos(angle) * radius).attr("y2", Math.sin(angle) * radius).attr("stroke", "#eee");
            
            svg.append("text").attr("x", x).attr("y", y).text(s)
                .attr("text-anchor", "middle")
                .style("font-size", "16px") // Fonte maior (16px)
                .style("font-weight", "600")
                .style("fill", "#495057");
        });
        
        [5, 10, 15].forEach(v => svg.append("circle").attr("r", rScale(v)).attr("fill", "none").attr("stroke", "#f0f0f0").attr("stroke-width", 1.5));

        const meanPre = orderedScales.map(s => d3.mean(rawData.filter(d => d.scale === s), d => d.pre));
        const meanPost = orderedScales.map(s => d3.mean(rawData.filter(d => d.scale === s), d => d.post));
        
        const line = d3.lineRadial().angle((d, i) => i * angleSlice).radius(d => rScale(d)).curve(d3.curveLinearClosed);

        const pathPre = svg.append("path").datum(meanPre).attr("fill", "var(--color-pre)").attr("fill-opacity", 0.3).attr("d", line);
        const pathPost = svg.append("path").datum(meanPost).attr("fill", "var(--color-highlight)").attr("fill-opacity", 0.5).attr("stroke", "#e0a800").attr("stroke-width", 4).attr("d", line).attr("opacity", 0);

        return function play() {
            pathPre.attr("opacity", 0).transition().duration(1000).attr("opacity", 1);
            pathPost.datum(meanPre).attr("d", line).attr("opacity", 0) 
                    .transition().delay(800).duration(1500).ease(d3.easeElastic)
                    .attr("opacity", 1)
                    .attrTween("d", function() {
                        const i = d3.interpolateArray(meanPre, meanPost);
                        return t => line(i(t));
                    });
        };
    }

    // --- 3. DUMBBELL CHART (VERSÃO FINAL "IDEAL") ---
    function initDumbbell() {
        const container = d3.select("#chart-dumbbell");
        const width = container.node().getBoundingClientRect().width;
        
        const height = 500; 
        const margin = {top: 20, right: 30, bottom: 30, left: 100};
        
        const svg = container.append("svg").attr("viewBox", `0 0 ${width} ${height}`).append("g").attr("transform", `translate(${margin.left},${margin.top})`);

        const summary = scales.map(s => ({
            scale: s,
            pre: d3.mean(rawData.filter(x => x.scale === s), x => x.pre),
            post: d3.mean(rawData.filter(x => x.scale === s), x => x.post)
        })).sort((a,b) => Math.abs(b.post - b.pre) - Math.abs(a.post - a.pre));

        // Zoom automático baseado no máximo
        const maxVal = d3.max(summary, d => Math.max(d.pre, d.post)) || 10;
        
        const x = d3.scaleLinear().range([0, width - margin.left - margin.right]).domain([0, maxVal * 1.1]);
        const y = d3.scaleBand().range([0, height - margin.top - margin.bottom]).domain(summary.map(d => d.scale)).padding(1);

        // Grid e Eixos
        svg.append("g").attr("transform", `translate(0,${height - margin.top - margin.bottom})`).call(d3.axisBottom(x));
        svg.append("g").call(d3.axisLeft(y).tickSize(0)).select(".domain").remove();
        svg.selectAll(".tick text").style("font-size", "14px").style("fill", "#212529").style("font-weight", "600");

        svg.append("g")
            .attr("class", "grid")
            .attr("transform", `translate(0,${height - margin.top - margin.bottom})`)
            .call(d3.axisBottom(x).ticks(5).tickSize(-(height - margin.top - margin.bottom)).tickFormat(""));

        const groups = svg.selectAll("g.dumbbell").data(summary).enter().append("g");
        
        // Linha guia de fundo
        groups.append("line").attr("x1", 0).attr("x2", width).attr("y1", d => y(d.scale)).attr("y2", d => y(d.scale)).attr("stroke", "#f8f9fa").attr("stroke-width", 2);

        // Função auxiliar para determinar cor (Verde = Bom, Vermelho = Ruim)
        const getColorStatus = (d) => {
            const isBadScale = !['Vigor'].includes(d.scale); // Escalas ruins (Tensão, etc)
            const diff = d.post - d.pre;
            // Se escala ruim diminuiu OU escala boa aumentou = VERDE, senão VERMELHO
            return (isBadScale && diff <= 0) || (!isBadScale && diff >= 0) ? "#198754" : "#dc3545";
        };

        // 1. Linha Conectora
        const connectors = groups.append("line")
            .attr("y1", d => y(d.scale)).attr("y2", d => y(d.scale))
            .attr("stroke", d => getColorStatus(d))
            .attr("stroke-width", 4)
            .attr("stroke-opacity", 0.6); // Leve transparência para não brigar com as bolas

        // 2. Bolinha "Pré" (ESTILO FANTASMA/ANEL)
        // Preenchimento branco e borda cinza. Isso permite ver sobreposição.
        const cPre = groups.append("circle").attr("cy", d => y(d.scale)).attr("r", 7)
            .attr("fill", "white") 
            .attr("stroke", "#adb5bd") // Cinza neutro
            .attr("stroke-width", 2);
            
        // 3. Bolinha "Pós" (SÓLIDA E COLORIDA)
        // Agora a bolinha final carrega a cor do status (Verde/Vermelho)
        const cPost = groups.append("circle").attr("cy", d => y(d.scale)).attr("r", 9)
            .attr("fill", d => getColorStatus(d)) 
            .attr("stroke", "white")
            .attr("stroke-width", 2);
        
        // 4. Texto do Valor (COLORIDO)
        const lbl = groups.append("text")
            .attr("y", d => y(d.scale) - 18) 
            .text(d => {
                const val = (d.post-d.pre).toFixed(1);
                return val > 0 ? `+${val}` : val; 
            })
            .attr("text-anchor", "middle")
            .style("font-size", "15px")   
            .style("font-weight", "800") 
            .style("fill", d => getColorStatus(d)); // Texto na mesma cor da bolinha

        // Animação
        return function play() {
            connectors.attr("x1", d => x(d.pre)).attr("x2", d => x(d.pre))
                .transition().duration(1000).delay((d,i) => i*100).attr("x2", d => x(d.post));
            
            cPre.attr("cx", d => x(d.pre)).attr("opacity", 0).transition().duration(500).attr("opacity", 1);
            
            cPost.attr("cx", d => x(d.post)).attr("opacity", 0).transition().delay((d,i)=>800+i*100).duration(500).attr("opacity", 1);
            
            lbl.attr("x", d => (x(d.pre)+x(d.post))/2).attr("opacity", 0).transition().delay(1200).duration(500).attr("opacity", 1);
        };
    }

    // --- 4. SLOPE CHART ---
    function initSlope() {
        const container = d3.select("#chart-slope");
        const width = container.node().getBoundingClientRect().width;
        const height = 400;
        const margin = {top: 20, right: 50, bottom: 30, left: 50};
        const svg = container.append("svg").attr("viewBox", `0 0 ${width} ${height}`).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
        
        const x = d3.scalePoint().domain(['Pré', 'Pós']).range([0, width - margin.left - margin.right]).padding(0.1);
        const y = d3.scaleLinear().range([height - margin.top - margin.bottom, 0]);

        const xAxis = svg.append("g").attr("transform", `translate(0,${height - margin.top - margin.bottom})`).call(d3.axisBottom(x).tickSize(0));
        xAxis.select(".domain").remove();
        xAxis.selectAll(".tick text").style("font-size", "14px").style("font-weight", "bold");
        
        const yAxis = svg.append("g");

        const lineGroup = svg.append("g");
        
        function update(selectedScale, animate=true) {
            const data = rawData.filter(d => d.scale === selectedScale);
            const means = modalities.map(mod => ({
                modality: mod, 
                pre: d3.mean(data.filter(d => d.modality === mod), d => d.pre), 
                post: d3.mean(data.filter(d => d.modality === mod), d => d.post)
            })).filter(d => d.pre !== undefined);

            const maxVal = d3.max(data, d => Math.max(d.pre, d.post));
            y.domain([0, Math.max(12, maxVal * 1.1)]); 

            yAxis.transition().duration(500).call(d3.axisLeft(y).ticks(5));

            svg.selectAll(".grid-line").remove();
            svg.append("g").attr("class", "grid-line grid")
                .call(d3.axisLeft(y).tickSize(-(width - margin.left - margin.right)).tickFormat(""));

            const uLines = lineGroup.selectAll(".ind-line").data(data, d => d.id);
            uLines.enter().append("line").attr("class", "ind-line")
                .attr("stroke", "#e9ecef").attr("stroke-width", 1)
                .merge(uLines)
                .attr("x1", x('Pré')).attr("x2", animate ? x('Pré') : x('Pós'))
                .attr("y1", d => y(d.pre)).attr("y2", d => y(d.pre))
                .transition().duration(animate ? 1500 : 500).delay((d,i) => animate ? i*10 : 0)
                .attr("x2", x('Pós')).attr("y2", d => y(d.post));
            uLines.exit().remove();

            const uMeans = lineGroup.selectAll(".mean-line").data(means);
            uMeans.enter().append("line").attr("class", "mean-line")
                .attr("stroke", d => getColor(d.modality))
                .attr("stroke-width", 4).attr("stroke-linecap", "round")
                .merge(uMeans)
                .attr("x1", x('Pré')).attr("x2", x('Pré'))
                .attr("y1", d => y(d.pre)).attr("y2", d => y(d.pre))
                .transition().duration(1500).delay(500)
                .attr("x2", x('Pós')).attr("y2", d => y(d.post));
            uMeans.exit().remove();
        }

        const sel = d3.select("#scaleSelect");
        sel.selectAll("option").data(scales).enter().append("option").text(d => d).attr("value", d => d);
        sel.on("change", function() { update(this.value, true); });

        return () => update(sel.property("value") || scales[0], true);
    }

    // --- INICIALIZAÇÃO ---
    const playTMD = initTMD();
    const playRadar = initRadar();
    const playDumbbell = initDumbbell();
    const playSlopeFn = initSlope();

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if(entry.isIntersecting) {
                entry.target.classList.add("visible");
                const id = entry.target.id;
                if(id === 'section-tmd') playTMD();
                if(id === 'section-radar') playRadar();
                if(id === 'section-dumbbell') playDumbbell();
                if(id === 'section-slope') playSlopeFn();
                observer.unobserve(entry.target);
            }
        });
    }, { threshold: 0.3 });

    document.querySelectorAll('.story-section').forEach(section => observer.observe(section));

</script>
</body>
</html>